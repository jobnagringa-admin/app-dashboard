---
/**
 * AuthProvider Component
 *
 * Sets up Clerk authentication for the application.
 * Should be included in the <head> of your layout.
 *
 * Features:
 * - Clerk JS SDK initialization
 * - User session persistence
 * - Protected path enforcement
 * - Community content gating
 *
 * @usage
 * ```astro
 * ---
 * import AuthProvider from '../components/AuthProvider.astro';
 * ---
 * <head>
 *   <AuthProvider />
 * </head>
 * ```
 *
 * Environment Variables:
 * - PUBLIC_CLERK_PUBLISHABLE_KEY: Clerk publishable key
 * - PUBLIC_CLERK_DOMAIN: Clerk domain (optional)
 */

export interface Props {
  /**
   * Clerk publishable key
   * Falls back to environment variable
   */
  publishableKey?: string;

  /**
   * Custom Clerk domain
   */
  clerkDomain?: string;

  /**
   * Enable protected path enforcement
   * @default true
   */
  enforceProtection?: boolean;
}

const {
  publishableKey = import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY ||
    'pk_live_Y2xlcmsuam9ibmFncmluZ2EuY29tLmJyJA',
  clerkDomain = import.meta.env.PUBLIC_CLERK_DOMAIN || 'https://clerk.jobnagringa.com.br',
  enforceProtection = true,
} = Astro.props;

const clerkScriptUrl = `${clerkDomain}/npm/@clerk/clerk-js@5/dist/clerk.browser.js`;
---

<!-- Clerk SDK -->
<script
  async
  crossorigin="anonymous"
  data-clerk-publishable-key={publishableKey}
  src={clerkScriptUrl}></script>

<!-- Clerk Initialization -->
<script define:vars={{ enforceProtection }}>
  // Configuration
  const COOKIE_NAME = 'user';
  const LOCAL_KEY = 'user';
  const COOKIE_TTL = 86400;
  const DOMAIN_SUFFIX = '.jobnagringa.com.br';
  const ACCOUNTS_URL = 'https://accounts.jobnagringa.com.br';
  const PROTECTED_PATHS = ['/jng'];
  const HOME_PATH = '/';

  // Cookie utilities
  function setCookie(name, value, maxAge, options = {}) {
    const parts = [
      encodeURIComponent(name) + '=' + encodeURIComponent(value),
      'path=/',
      'max-age=' + maxAge,
    ];
    if (options.domain) parts.push('domain=' + options.domain);
    if (options.secure) parts.push('secure');
    if (options.sameSite) parts.push('samesite=' + options.sameSite);
    document.cookie = parts.join('; ');
  }

  function getUserFromCookie() {
    try {
      const cookies = document.cookie ? document.cookie.split(';') : [];
      let cookieValue = null;

      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(COOKIE_NAME + '=')) {
          cookieValue = cookie;
          break;
        }
      }

      if (!cookieValue) return null;

      const encoded = cookieValue.split('=')[1] || '';
      const decoded = decodeURIComponent(encoded);
      return decoded ? JSON.parse(decoded) : null;
    } catch (e) {
      return null;
    }
  }

  // User data persistence
  function persistUserData(user) {
    window.user = user;

    try {
      localStorage.setItem(LOCAL_KEY, JSON.stringify(user));
    } catch (e) {}

    try {
      let email = null;
      let phoneNumber = null;

      if (user?.primaryEmailAddress?.emailAddress) {
        email = user.primaryEmailAddress.emailAddress;
      } else if (user?.emailAddresses?.length) {
        email = user.emailAddresses[0]?.emailAddress || null;
      }

      if (user?.primaryPhoneNumber?.phoneNumber) {
        phoneNumber = user.primaryPhoneNumber.phoneNumber;
      } else if (user?.phoneNumbers?.length) {
        phoneNumber = user.phoneNumbers[0]?.phoneNumber || null;
      }

      const userData = {
        firstName: user?.firstName || null,
        phoneNumber,
        email,
        publicMetadata: user?.publicMetadata || {},
      };

      const isSecure = window.location.protocol === 'https:';
      const hostname = window.location.hostname;
      const domain = hostname.endsWith(DOMAIN_SUFFIX) ? DOMAIN_SUFFIX : undefined;

      setCookie(COOKIE_NAME, JSON.stringify(userData), COOKIE_TTL, {
        secure: isSecure,
        sameSite: 'Strict',
        domain,
      });
    } catch (e) {}
  }

  // Authorization checks
  function userIsPaidCustomer() {
    try {
      const user = getUserFromCookie();
      return user?.publicMetadata?.isPaidCustomer === true;
    } catch (e) {
      return false;
    }
  }

  function isProtectedPath() {
    const pathname = window.location.pathname;
    return PROTECTED_PATHS.some((path) => pathname.startsWith(path));
  }

  // Protected path enforcement (runs immediately)
  if (enforceProtection && isProtectedPath()) {
    const style = document.createElement('style');
    style.textContent = 'html { visibility: hidden !important; }';
    (document.head || document.documentElement).appendChild(style);

    if (!userIsPaidCustomer()) {
      window.location.replace(HOME_PATH);
    } else {
      document.documentElement.style.visibility = 'visible';
      style.remove();
    }
  }

  // Community content handling
  function handleCommunityContent() {
    const isPaid = userIsPaidCustomer();
    const selector = isPaid ? '[data-ms-content="!community"]' : '[data-ms-content="community"]';
    const elements = document.querySelectorAll(selector);
    elements.forEach((el) => el.remove());
  }

  // First name population
  function populateFirstNameFromUser() {
    const user = getUserFromCookie();
    if (!user) return;

    const firstName = (user.firstName || '').trim();
    if (!firstName) return;

    const elements = document.querySelectorAll('[data-ms-member="first-name"]');
    elements.forEach((el) => {
      if ('value' in el) {
        el.value = firstName;
      } else {
        el.textContent = firstName;
      }
    });
  }

  // Clerk initialization
  function initClerk() {
    if (!window.Clerk?.load) return;

    const promise = window.Clerk.load();
    if (promise?.then) {
      promise
        .then(() => {
          if (window.Clerk?.user) {
            persistUserData(window.Clerk.user);
          }
        })
        .catch(() => {});
    } else {
      setTimeout(() => {
        if (window.Clerk?.user) {
          persistUserData(window.Clerk.user);
        }
      }, 1000);
    }
  }

  // DOM ready functions
  function runDomFuncs() {
    populateFirstNameFromUser();
    handleCommunityContent();
  }

  // Event listeners
  window.addEventListener('load', initClerk);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runDomFuncs);
  } else {
    runDomFuncs();
  }

  window.addEventListener('load', runDomFuncs);
</script>
