---
/**
 * MauticTracking Component
 *
 * Sets up Mautic marketing automation tracking.
 * Include this at the end of <body> for optimal performance.
 *
 * Features:
 * - Page view tracking
 * - Form submission tracking
 * - User identification via Memberstack data
 *
 * @usage
 * ```astro
 * ---
 * import MauticTracking from '../components/MauticTracking.astro';
 * ---
 * <body>
 *   ...
 *   <MauticTracking />
 * </body>
 * ```
 *
 * Environment Variables:
 * - PUBLIC_MAUTIC_URL: Mautic instance URL
 */

export interface Props {
  /**
   * Mautic tracking script URL
   */
  mauticUrl?: string;

  /**
   * Disable tracking
   */
  disabled?: boolean;
}

const {
  mauticUrl = import.meta.env.PUBLIC_MAUTIC_URL ||
    'https://mautic.jobnagringa.com.br/mtc.js',
  disabled = false,
} = Astro.props;
---

{!disabled && (
  <script data-cfasync="false" define:vars={{ mauticUrl }}>
    // Initialize Mautic tracking object
    (function (w, d, t, u, n, a, m) {
      w['MauticTrackingObject'] = n;
      w[n] =
        w[n] ||
        function () {
          (w[n].q = w[n].q || []).push(arguments);
        };
      a = d.createElement(t);
      m = d.getElementsByTagName(t)[0];
      a.async = 1;
      a.src = u;
      m.parentNode.insertBefore(a, m);
    })(window, document, 'script', mauticUrl, 'mt');

    document.addEventListener('DOMContentLoaded', function () {
      // Send pageview with user data if available
      function sendMauticPageview() {
        try {
          const memberMetadata = localStorage.getItem('_ms-mem');
          if (memberMetadata) {
            const member = JSON.parse(memberMetadata);
            if (member?.id) {
              const email = member.auth?.email || '';
              const firstname = member.customFields?.['first-name'] || '';
              mt('send', 'pageview', { email, firstname });
              return;
            }
          }
        } catch (error) {
          console.error('Error reading member metadata:', error);
        }
        mt('send', 'pageview');
      }

      sendMauticPageview();

      // Track form submissions
      function handleFormSubmit(event) {
        try {
          const form = event.target;
          const emailField = form.querySelector('input[type="email"]');
          if (emailField?.value) {
            if (typeof mt === 'function') {
              mt('send', 'formsubmit', { email: emailField.value });
            }
          }
        } catch (error) {
          console.error('Error handling form submission:', error);
        }
      }

      document.body.addEventListener('submit', function (event) {
        if (event.target.tagName.toLowerCase() === 'form') {
          handleFormSubmit(event);
        }
      });
    });
  </script>
)}
