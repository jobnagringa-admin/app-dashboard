---
/**
 * ContentGating.astro
 *
 * Content Protection and Access Control
 *
 * Purpose:
 * - Protect premium content from non-paying users
 * - Redirect unauthorized users to sign-in
 * - Hide/show content based on subscription status
 *
 * Data Attributes Used:
 * - data-ms-content="community" - Show only to paid members
 * - data-ms-content="!community" - Hide from paid members
 * - data-ms-member="first-name" - Populate with user's first name
 *
 * Protected Paths:
 * - /jng/* - Members-only content area
 *
 * Migration Notes:
 * - Original uses CSS visibility:hidden then reveals on auth check
 * - Prevents content flash for protected pages
 * - Checks user cookie for isPaidCustomer metadata
 * - Redirects to home (/) if not authorized
 *
 * ASTRO MIGRATION APPROACH:
 *
 * Option A: Client-side (current approach)
 * - Works with static generation
 * - Content visible in source (SEO risk for premium content)
 * - Fast initial load with JS gating
 *
 * Option B: Server-side (recommended for sensitive content)
 * - Use Astro middleware for auth checks
 * - Redirect before page renders
 * - Content not exposed in static HTML
 * - Requires SSR mode
 *
 * Option C: Hybrid
 * - SSR for protected routes
 * - SSG for public content
 * - Best of both worlds
 */

interface Props {
  /**
   * Protected path prefixes
   * @default ['/jng']
   */
  protectedPaths?: string[];

  /**
   * Redirect path for unauthorized users
   * @default '/'
   */
  redirectPath?: string;

  /**
   * Enable content flash protection
   * @default true
   */
  preventFlash?: boolean;
}

const {
  protectedPaths = ['/jng'],
  redirectPath = '/',
  preventFlash = true
} = Astro.props;
---

{/* Flash prevention style - hides page until auth check */}
{preventFlash && (
  <style is:inline>
    html.content-protected {
      visibility: hidden !important;
    }
  </style>
)}

<script is:inline define:vars={{ protectedPaths, redirectPath, preventFlash }}>
  (function() {
    /**
     * Check if current path is protected
     */
    function isProtectedPath() {
      const pathname = window.location.pathname;
      return protectedPaths.some(path => pathname.startsWith(path));
    }

    /**
     * Get user data from cookie
     */
    function getUserFromCookie() {
      try {
        const cookies = document.cookie.split(";");
        for (const cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith("user=")) {
            const value = decodeURIComponent(trimmed.split("=")[1] || "");
            if (value) {
              return JSON.parse(value);
            }
          }
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    /**
     * Check if user is a paid customer
     */
    function userIsPaidCustomer() {
      const user = getUserFromCookie();
      return !!(user?.publicMetadata?.isPaidCustomer === true);
    }

    /**
     * Redirect to home/login
     */
    function redirectToHome() {
      if (window.location.replace) {
        window.location.replace(redirectPath);
      } else {
        window.location.href = redirectPath;
      }
    }

    /**
     * Show the page (remove flash protection)
     */
    function showPage() {
      document.documentElement.classList.remove('content-protected');
      document.documentElement.style.visibility = 'visible';
    }

    /**
     * Handle content visibility based on subscription
     */
    function handleContentVisibility() {
      const isPaid = userIsPaidCustomer();

      // Remove content that shouldn't be shown
      const selector = isPaid
        ? '[data-ms-content="!community"]'
        : '[data-ms-content="community"]';

      document.querySelectorAll(selector).forEach(el => {
        el.remove();
      });
    }

    // Main protection logic
    if (!isProtectedPath()) {
      // Not a protected path, just handle content visibility
      if (preventFlash) {
        showPage();
      }
      document.addEventListener('DOMContentLoaded', handleContentVisibility);
      return;
    }

    // Protected path - add flash protection class
    if (preventFlash) {
      document.documentElement.classList.add('content-protected');
    }

    // Check authorization
    const user = getUserFromCookie();

    if (!user) {
      // No user cookie, redirect
      redirectToHome();
      return;
    }

    if (!userIsPaidCustomer()) {
      // User exists but not paid, redirect
      redirectToHome();
      return;
    }

    // User is authorized, show page
    showPage();
    document.addEventListener('DOMContentLoaded', handleContentVisibility);
  })();
</script>
