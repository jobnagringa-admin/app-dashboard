---
/**
 * MauticTracker.astro
 *
 * Mautic Marketing Automation Tracking
 *
 * Purpose:
 * - Track page views with user identification
 * - Track form submissions for lead capture
 * - Integrate with Memberstack user data (legacy)
 * - Integrate with Clerk user data (current)
 *
 * Environment Variables Required:
 * - PUBLIC_MAUTIC_URL: Mautic tracking URL (e.g., https://mautic.jobnagringa.com.br)
 *
 * Migration Notes:
 * - Original reads from Memberstack localStorage key: _ms-mem
 * - Current implementation uses Clerk cookie data
 * - Tracks pageviews and form submissions automatically
 * - Uses data-cfasync="false" to prevent Cloudflare Rocket Loader issues
 */

interface Props {
  /**
   * Mautic tracking URL override
   */
  mauticUrl?: string;

  /**
   * Track form submissions automatically
   * @default true
   */
  trackForms?: boolean;

  /**
   * Track page views automatically
   * @default true
   */
  trackPageViews?: boolean;
}

const {
  mauticUrl,
  trackForms = true,
  trackPageViews = true
} = Astro.props;

const mauticBaseUrl = mauticUrl || import.meta.env.PUBLIC_MAUTIC_URL || 'https://mautic.jobnagringa.com.br';
---

<!-- Mautic Tracking Script -->
<script data-cfasync="false" is:inline define:vars={{ mauticBaseUrl, trackForms, trackPageViews }}>
  (function(w, d, t, u, n, a, m) {
    w["MauticTrackingObject"] = n;
    w[n] = w[n] || function() {
      (w[n].q = w[n].q || []).push(arguments);
    };
    a = d.createElement(t);
    m = d.getElementsByTagName(t)[0];
    a.async = 1;
    a.src = u;
    m.parentNode.insertBefore(a, m);
  })(window, document, "script", mauticBaseUrl + "/mtc.js", "mt");

  document.addEventListener("DOMContentLoaded", function() {
    /**
     * Get user data from available sources
     * Priority: Clerk cookie > Memberstack localStorage
     */
    function getUserData() {
      // Try Clerk cookie first (current auth system)
      try {
        const cookies = document.cookie.split(";");
        for (const cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith("user=")) {
            const value = decodeURIComponent(trimmed.split("=")[1] || "");
            if (value) {
              const user = JSON.parse(value);
              if (user?.email) {
                return {
                  email: user.email,
                  firstname: user.firstName || ""
                };
              }
            }
          }
        }
      } catch (e) {
        console.warn("Error reading Clerk cookie:", e);
      }

      // Fallback to Memberstack localStorage (legacy)
      try {
        const memberMetadata = localStorage.getItem("_ms-mem");
        if (memberMetadata) {
          const member = JSON.parse(memberMetadata);
          if (member?.id) {
            return {
              email: member.auth?.email || "",
              firstname: member.customFields?.["first-name"] || ""
            };
          }
        }
      } catch (e) {
        console.warn("Error reading member metadata:", e);
      }

      return null;
    }

    /**
     * Send pageview with user identification
     */
    function sendMauticPageview() {
      if (!trackPageViews) return;

      const userData = getUserData();

      if (userData?.email) {
        mt("send", "pageview", {
          email: userData.email,
          firstname: userData.firstname
        });
      } else {
        mt("send", "pageview");
      }
    }

    /**
     * Handle form submissions
     */
    function handleFormSubmit(event) {
      if (!trackForms) return;

      try {
        const form = event.target;
        if (form.tagName.toLowerCase() !== "form") return;

        const emailField = form.querySelector('input[type="email"]');
        if (emailField?.value) {
          mt("send", "formsubmit", {
            email: emailField.value
          });
        }
      } catch (error) {
        console.warn("Error handling form submission:", error);
      }
    }

    // Initialize tracking
    sendMauticPageview();

    // Set up form submission tracking
    if (trackForms) {
      document.body.addEventListener("submit", handleFormSubmit, true);
    }
  });
</script>
