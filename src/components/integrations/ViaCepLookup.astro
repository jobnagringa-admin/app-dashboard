---
/**
 * ViaCepLookup.astro
 *
 * Brazilian CEP (Postal Code) Lookup Integration
 *
 * Purpose:
 * - Auto-fill address fields based on CEP input
 * - Uses ViaCEP API (free Brazilian postal code service)
 *
 * API:
 * - URL: https://viacep.com.br/ws/{cep}/json/
 * - No API key required
 * - Returns: logradouro, bairro, localidade, uf
 *
 * Field Mapping:
 * - #cep -> CEP input field
 * - #endereco -> Street address (logradouro)
 * - #bairro -> Neighborhood (bairro)
 * - #cidade -> City (localidade)
 * - #uf -> State (uf)
 *
 * Migration Notes:
 * - Original uses jQuery for AJAX call
 * - Modern version uses native fetch API
 * - Triggers on blur event of CEP field
 * - Validates 8-digit CEP format
 */

interface Props {
  /**
   * CEP input field selector
   * @default '#cep'
   */
  cepSelector?: string;

  /**
   * Address field selector
   * @default '#endereco'
   */
  addressSelector?: string;

  /**
   * Neighborhood field selector
   * @default '#bairro'
   */
  neighborhoodSelector?: string;

  /**
   * City field selector
   * @default '#cidade'
   */
  citySelector?: string;

  /**
   * State field selector
   * @default '#uf'
   */
  stateSelector?: string;
}

const {
  cepSelector = '#cep',
  addressSelector = '#endereco',
  neighborhoodSelector = '#bairro',
  citySelector = '#cidade',
  stateSelector = '#uf'
} = Astro.props;
---

<script is:inline define:vars={{
  cepSelector,
  addressSelector,
  neighborhoodSelector,
  citySelector,
  stateSelector
}}>
  document.addEventListener('DOMContentLoaded', function() {
    const cepInput = document.querySelector(cepSelector);

    if (!cepInput) return;

    /**
     * Lookup address by CEP using ViaCEP API
     */
    async function lookupCep(cep) {
      // Remove non-numeric characters
      const cleanCep = cep.replace(/\D/g, '');

      // Validate 8-digit format
      if (cleanCep.length !== 8) {
        return null;
      }

      try {
        const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);

        if (!response.ok) {
          throw new Error('CEP lookup failed');
        }

        const data = await response.json();

        // ViaCEP returns {erro: true} for invalid CEPs
        if (data.erro) {
          return null;
        }

        return data;
      } catch (error) {
        console.warn('CEP lookup error:', error);
        return null;
      }
    }

    /**
     * Fill address fields with API response
     */
    function fillAddressFields(data) {
      const addressField = document.querySelector(addressSelector);
      const neighborhoodField = document.querySelector(neighborhoodSelector);
      const cityField = document.querySelector(citySelector);
      const stateField = document.querySelector(stateSelector);

      if (addressField && data.logradouro) {
        addressField.value = data.logradouro;
      }

      if (neighborhoodField && data.bairro) {
        neighborhoodField.value = data.bairro;
      }

      if (cityField && data.localidade) {
        cityField.value = data.localidade;
      }

      if (stateField && data.uf) {
        stateField.value = data.uf;
      }
    }

    /**
     * Handle CEP input blur event
     */
    async function handleCepBlur(event) {
      const cep = event.target.value;

      if (!cep) return;

      const data = await lookupCep(cep);

      if (data) {
        fillAddressFields(data);
      }
    }

    // Add blur event listener
    cepInput.addEventListener('blur', handleCepBlur);
  });
</script>
