---
/**
 * ClientScripts Component
 *
 * Loads all client-side JavaScript functionality for the site.
 * This component should be included in the main layout.
 *
 * Scripts included:
 * - Webflow interactions (webflow.js)
 * - Finsweet CMS attributes
 * - Custom initialization
 *
 * @usage
 * ```astro
 * <ClientScripts />
 * ```
 *
 * Script Loading Strategy:
 * - jQuery: sync (required by Webflow)
 * - webflow.js: defer (after jQuery)
 * - Finsweet: async (non-blocking)
 * - Custom scripts: module (ES modules)
 */

export interface Props {
  /**
   * Include Finsweet CMS attributes
   * @default true
   */
  includeFinsweet?: boolean;

  /**
   * Include Slater scripts for home page
   * @default false
   */
  includeSlater?: boolean;

  /**
   * Slater script URL
   */
  slaterUrl?: string;
}

const {
  includeFinsweet = true,
  includeSlater = false,
  slaterUrl = 'https://slater.app/8634/22027.js',
} = Astro.props;

// Webflow site ID for jQuery
const WEBFLOW_SITE_ID = '642953c962519376c853ab81';
---

<!-- jQuery (required by Webflow) -->
<script
  is:inline
  src={`https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=${WEBFLOW_SITE_ID}`}
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"
></script>

<!-- Webflow.js -->
<script is:inline src="/js/webflow.js" defer></script>

{includeFinsweet && (
  <>
    <!-- Finsweet CMS Load -->
    <script
      is:inline
      async
      src="https://cdn.jsdelivr.net/npm/@finsweet/attributes-cmsload@1/cmsload.js"
    ></script>

    <!-- Finsweet CMS Filter -->
    <script
      is:inline
      async
      src="https://cdn.jsdelivr.net/npm/@finsweet/attributes-cmsfilter@1/cmsfilter.js"
    ></script>
  </>
)}

{includeSlater && (
  <script is:inline define:vars={{ slaterUrl }}>
    document.addEventListener('DOMContentLoaded', function () {
      function loadSlater(src) {
        const script = document.createElement('script');
        script.setAttribute('src', src);
        script.setAttribute('type', 'text/javascript');
        document.body.appendChild(script);
        script.addEventListener('load', () => {
          console.log('Slater loaded:', src);
        });
        script.addEventListener('error', (e) => {
          console.log('Error loading Slater:', e);
        });
      }

      // Use production URL in production, dev URL otherwise
      const productionUrl = slaterUrl.replace('slater.app', 'assets.slater.app/slater');
      const isProduction = !window.location.host.includes('webflow.io');
      const scriptUrl = isProduction ? productionUrl : slaterUrl;

      loadSlater(scriptUrl);
    });
  </script>
)}

<!-- Initialize custom scripts -->
<script>
  import { initAuth } from '../scripts/auth';
  import { initTracking } from '../scripts/tracking';
  import { initAPI } from '../scripts/api';
  import { initUtils } from '../scripts/utils';

  // Initialize all modules
  initUtils();
  initAuth();
  initTracking();
  initAPI();
</script>
