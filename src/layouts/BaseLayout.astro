---
/**
 * BaseLayout Component - Common HTML structure for all pages
 *
 * This is the base layout that integrates Head, Navigation, and Footer components.
 * Use this for pages that need full flexibility, or use DashboardLayout/LandingLayout
 * for more specific use cases.
 *
 * This layout includes:
 * - Meta tags for SEO (via Head component)
 * - Clerk authentication scripts
 * - Google Analytics and GTM
 * - Mautic tracking
 * - Global styles from Webflow
 * - Navigation and Footer components
 *
 * @prop {string} title - Page title
 * @prop {string} description - Meta description
 * @prop {string} ogTitle - Open Graph title
 * @prop {string} ogDescription - Open Graph description
 * @prop {string} ogImage - Open Graph image URL
 * @prop {boolean} noIndex - Whether to add noindex meta tag
 * @prop {string} lang - HTML lang attribute
 * @prop {boolean} isMemberNav - Show member navigation
 * @prop {string} currentPage - Current page for nav active state
 * @prop {boolean} showWhatsappSupport - Show WhatsApp support button
 * @prop {string} bodyClass - Additional body class
 * @prop {string} pageWrapperClass - Page wrapper class (page-wrapper or page_wrapper)
 * @prop {boolean} includeNavigation - Include navigation component (default: true)
 * @prop {boolean} includeFooter - Include footer component (default: true)
 */

import Head from '../components/Head.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title: string;
  description?: string;
  ogTitle?: string;
  ogDescription?: string;
  ogImage?: string;
  noIndex?: boolean;
  lang?: string;
  isMemberNav?: boolean;
  currentPage?: string;
  showWhatsappSupport?: boolean;
  bodyClass?: string;
  pageWrapperClass?: string;
  includeNavigation?: boolean;
  includeFooter?: boolean;
}

const {
  title,
  description = 'Encontre vagas internacionais para brasileiros. Trabalhe remoto para empresas dos EUA e Europa.',
  ogTitle,
  ogDescription,
  ogImage = '/images/og-image-jng.jpg',
  noIndex = false,
  lang = 'pt-BR',
  isMemberNav = false,
  currentPage = '',
  showWhatsappSupport = false,
  bodyClass = '',
  pageWrapperClass = 'page-wrapper',
  includeNavigation = true,
  includeFooter = true,
} = Astro.props;

// Environment variables
const clerkPublishableKey =
  import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY || 'pk_live_Y2xlcmsuam9ibmFncmluZ2EuY29tLmJyJA';
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID || 'G-DNCKG4JJ77';
const gtmId = import.meta.env.PUBLIC_GTM_ID || 'GTM-58XVRQZ';
const mauticUrl = import.meta.env.PUBLIC_MAUTIC_URL || 'https://mautic.jobnagringa.com.br';
const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://jobnagringa.com.br';

const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();
const fullOgImage = ogImage.startsWith('http') ? ogImage : new URL(ogImage, siteUrl).toString();
---

<!doctype html>
<html data-wf-site="642953c962519376c853ab81" lang={lang}>
  <head>
    <Head
      title={title}
      description={description}
      ogTitle={ogTitle || title}
      ogDescription={ogDescription || description}
      ogImage={fullOgImage}
      noIndex={noIndex}
      lang={lang}
    >
      <!-- Canonical URL -->
      <link rel="canonical" href={canonicalUrl} />

      <!--
      Google Tag Manager & Analytics
      Strategy: Use Partytown to run GTM in a web worker (off main thread)
      This eliminates GTM's impact on main thread blocking and TBT
    -->
      <script is:inline>
        // Initialize dataLayer before Partytown loads GTM
        window.dataLayer = window.dataLayer || [];
      </script>
      <script type="text/partytown" define:vars={{ gtmId }}>
        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
          j.async = true;
          j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
          f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', gtmId);
      </script>

      <slot name="head" />
    </Head>
  </head>
  <body class={bodyClass}>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe>
    </noscript>

    <div class={pageWrapperClass}>
      <!-- Global styles -->
      <div class="global-styles w-embed">
        <style>
          /* Make text look crisper and more legible in all browsers */
          body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
          }
          /* Focus state style for keyboard navigation for the focusable elements */
          *[tabindex]:focus-visible,
          input[type='file']:focus-visible {
            outline: 0.125rem solid #4d65ff;
            outline-offset: 0.125rem;
          }
          /* Set color style to inherit */
          .inherit-color * {
            color: inherit;
          }
          /* Get rid of top margin on first element in any rich text element */
          .w-richtext > :not(div):first-child,
          .w-richtext > div:first-child > :first-child {
            margin-top: 0 !important;
          }
          /* Get rid of bottom margin on last element in any rich text element */
          .w-richtext > :last-child,
          .w-richtext ol li:last-child,
          .w-richtext ul li:last-child {
            margin-bottom: 0 !important;
          }
          /* Make sure containers never lose their center alignment */
          .container-medium,
          .container-small,
          .container-large {
            margin-right: auto !important;
            margin-left: auto !important;
          }
        </style>
      </div>

      {includeNavigation && <Navigation isMemberNav={isMemberNav} currentPage={currentPage} />}

      <main>
        <slot />
      </main>

      {
        includeFooter && (
          <Footer showWhatsappSupport={showWhatsappSupport}>
            <slot name="footer-job-categories" slot="job-categories" />
          </Footer>
        )
      }
    </div>

    <!--
    Script Loading Strategy (Optimized for Lighthouse):
    1. Critical: Clerk auth (async) - needed for auth state
    2. Deferred: jQuery + Webflow - needed for UI interactions
    3. Lazy: Analytics (Mautic, Ahrefs) - loaded after page is interactive
    4. Async: Finsweet CMS - independent, can load anytime
  -->

    <!-- Clerk Authentication (async - critical for auth state) -->
    <script
      is:inline
      async
      crossorigin="anonymous"
      data-clerk-publishable-key={clerkPublishableKey}
      src="https://clerk.jobnagringa.com.br/npm/@clerk/clerk-js@5/dist/clerk.browser.js"></script>

    <!-- Clerk Helper Functions (defer - depends on Clerk but not critical path) -->
    <script defer src="/scripts/clerk-helpers.js"></script>

    <!--
    jQuery + Webflow (defer - needed for interactions but not critical render)
    Using defer ensures they execute in order after HTML parsing
  -->
    <script
      defer
      src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=642953c962519376c853ab81"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script defer src="/js/webflow.js"></script>

    <!-- Finsweet CMS Attributes (async - independent loading) -->
    <script async src="https://cdn.jsdelivr.net/npm/@finsweet/attributes-cmsload@1/cmsload.js"
    ></script>
    <script async src="https://cdn.jsdelivr.net/npm/@finsweet/attributes-cmsfilter@1/cmsfilter.js"
    ></script>

    <!--
    Non-critical Analytics (loaded after page becomes interactive)
    Using requestIdleCallback for lowest priority loading
  -->
    <script is:inline define:vars={{ mauticUrl }}>
      // Mautic tracking - load during idle time
      function loadMautic() {
        (function (w, d, t, u, n, a, m) {
          w['MauticTrackingObject'] = n;
          w[n] =
            w[n] ||
            function () {
              (w[n].q = w[n].q || []).push(arguments);
            };
          a = d.createElement(t);
          m = d.getElementsByTagName(t)[0];
          a.async = 1;
          a.src = u;
          m.parentNode.insertBefore(a, m);
        })(window, document, 'script', mauticUrl + '/mtc.js', 'mt');
        if (typeof mt === 'function') {
          mt('send', 'pageview');
        }
      }

      // Ahrefs analytics - load during idle time
      function loadAhrefs() {
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://analytics.ahrefs.com/analytics.js';
        s.setAttribute('data-key', '0IynPqzGcpJ1FaTQBiSG9g');
        document.body.appendChild(s);
      }

      // Load non-critical scripts after page is interactive
      if ('requestIdleCallback' in window) {
        requestIdleCallback(
          function () {
            loadMautic();
            loadAhrefs();
          },
          { timeout: 3000 }
        );
      } else {
        // Fallback for Safari - load after 2 seconds
        setTimeout(function () {
          loadMautic();
          loadAhrefs();
        }, 2000);
      }
    </script>

    <slot name="scripts" />
  </body>
</html>
